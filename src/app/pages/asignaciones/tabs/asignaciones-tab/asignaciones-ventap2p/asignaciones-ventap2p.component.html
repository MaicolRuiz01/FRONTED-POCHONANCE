<div class="card p-p-4 asig-scroll">
  <h2 class="p-mb-5 p-text-bold">Ventas de P2P Hoy</h2>

  <div *ngIf="loading" class="spinner-container">
    <p-progressSpinner></p-progressSpinner>
  </div>

  <p *ngIf="!loading && allAccountsp2p?.length === 0">No hay ventas para mostrar.</p>

  <app-mi-table [columns]="columns" [data]="allAccountsp2p" *ngIf="!isMobile">
    <ng-template #actionTemplate let-sale>
      <button pButton type="button" label="Asignar" icon="pi pi-check" class="p-button-success" [disabled]="loading"
        (click)="openAssignDialog(sale)">
      </button>
    </ng-template>

  </app-mi-table>

  <div *ngIf="isMobile">
    <app-card-list [data]="allAccountsp2p" [columns]="[
        { label: 'N° de orden', field: 'id' },
        { label: 'Fecha',       field: 'date' },
        { label: 'Dólares',     field: 'dollarsUs' },
        { label: 'Pesos COP',   field: 'pesosCop' },
        { label: 'Comisión',    field: 'commission' }
      ]">
      <ng-template #cardActionTemplate let-sale>
        <button pButton type="button" label="Asignar" icon="pi pi-check" class="p-button-success" [disabled]="loading"
          (click)="openAssignDialog(sale)">
        </button>


      </ng-template>
    </app-card-list>
  </div>

  <p-dialog header="Asignar cuenta(s) a la venta" [(visible)]="displayAssignDialog" [modal]="true" [closable]="true"
    [style]="{ width: '450px' }" [breakpoints]="{ '960px': '95vw' }">

    <div class="p-fluid p-formgrid p-grid">

      <!--Selector de banco por LOGOS -->
      <div class="p-field p-col-12">
        <label>Filtrar por banco</label>

        <div class="bank-logos">
          <button pButton type="button" class="bank-logo-btn" [ngClass]="{ 'active': selectedBankType === 'NEQUI' }"
            (click)="setBankFilter('NEQUI')">
            <img [src]="bankLogo('NEQUI')" alt="Nequi" />
          </button>

          <button pButton type="button" class="bank-logo-btn" [ngClass]="{ 'active': selectedBankType === 'DAVIPLATA' }"
            (click)="setBankFilter('DAVIPLATA')">
            <img [src]="bankLogo('DAVIPLATA')" alt="Daviplata" />
          </button>

          <button pButton type="button" class="bank-logo-btn"
            [ngClass]="{ 'active': selectedBankType === 'BANCOLOMBIA' }" (click)="setBankFilter('BANCOLOMBIA')">
            <img [src]="bankLogo('BANCOLOMBIA')" alt="Bancolombia" />
          </button>

          <!--opcional: botón "Todos" -->
          <button pButton type="button" class="bank-clear-btn" icon="pi pi-filter-slash" label="Todos"
            *ngIf="selectedBankType" (click)="setBankFilter(null)">
          </button>

        </div>
      </div>

      <!-- ✅ MultiSelect usa cuentasFiltradas -->
      <div class="p-field p-col-12">
        <label for="account">Seleccionar cuenta colombiana</label>

        <p-multiSelect id="account" [options]="cuentasFiltradas" [(ngModel)]="selectedAccounts" optionLabel="name"
          placeholder="Seleccionar cuentas" [appendTo]="'body'" (onChange)="onAccountsChange()">
        </p-multiSelect>

        <div class="p-field p-col-12 p-mt-3" *ngFor="let assignment of selectedAssignments">
          <label class="p-text-bold">{{ assignment.account.name }}</label>

          <p-inputNumber [(ngModel)]="assignment.amount" mode="decimal" locale="de-DE" [minFractionDigits]="2"
            [maxFractionDigits]="2" [placeholder]="'Monto para ' + assignment.account.name">
          </p-inputNumber>
        </div>
      </div>

    </div>



    <ng-template pTemplate="footer">
      <button pButton label="Cancelar" icon="pi pi-times" (click)="displayAssignDialog = false"
        class="p-button-text"></button>
      <button pButton type="button" label="Asignar" icon="pi pi-check" class="p-button-success" [disabled]="saving"
        (click)="assignAccounts()">
      </button>

    </ng-template>
  </p-dialog>
</div>