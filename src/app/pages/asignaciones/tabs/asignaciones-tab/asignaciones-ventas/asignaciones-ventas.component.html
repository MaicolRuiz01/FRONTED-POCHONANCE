<div class="card">
  <h2>Asignar Ventas</h2>
  
  <p *ngIf="loading" class="spinner-container">
    <p-progressSpinner></p-progressSpinner>
  </p>

  <!-- Tabla y cards (sin cambios) -->
  <app-mi-table [columns]="columns" [data]="filteredSales" *ngIf="!isMobile">
    <ng-template #actionTemplate let-sale>
      <p-button icon="pi pi-check-square" title="Asignar" styleClass="p-button-rounded p-button-sm"
        (click)="openAssignModal(sale)">
      </p-button>
    </ng-template>
  </app-mi-table>

  <div *ngIf="isMobile">
    <app-card-list [data]="filteredSales" [columns]="[
        { label: 'Cuenta', field: 'nameAccount' },
        { label: 'Cripto', field: 'cryptoSymbol' },
        { label: 'Monto', field: 'dollars' },
        { label: 'Cliente', field: 'getClienteById(sale.clienteId)?.nombre' },
        { label: 'Fecha', field: 'date' }
      ]">
      <ng-template #cardActionTemplate let-dep>
        <button pButton type="button" label="Asignar" class="p-button-sm p-button-success"
          (click)="openAssignModal(dep)">
        </button>
      </ng-template>
    </app-card-list>
  </div>
</div>

<!-- ========================================== -->
<!-- DIÁLOGO DE ASIGNACIÓN -->
<!-- ========================================== -->
<p-dialog 
  [header]="isSolanaSale ? 'Asignar Venta Solana' : 'Asignar Venta'" 
  [(visible)]="displayModal" 
  [modal]="true"
  [style]="{ width: '90vw', 'max-width': '600px' }" 
  (onHide)="closeModal()">
  
  <div *ngIf="selected" class="p-fluid p-formgrid p-grid">

    <!-- ============================================ -->
    <!-- FORMULARIO PARA VENTAS SOLANA -->
    <!-- ============================================ -->
    <ng-container *ngIf="isSolanaSale">
      
      <!-- Información básica -->
      <div class="p-field p-col-12 p-md-6">
        <label>Cuenta</label>
        <input pInputText [value]="selected.nameAccount" readonly class="w-full" />
      </div>

      <div class="p-field p-col-12 p-md-6">
        <label>Monto ({{selected.cryptoSymbol || 'USDT'}})</label>
        <input pInputText [value]="selected.dollars | number:'1.2-2'" readonly class="w-full" />
      </div>

      <div class="p-col-12 p-mt-3">
        <h3>Cuentas COP donde cayó el dinero</h3>
        <button pButton icon="pi pi-plus" label="Agregar cuenta" 
                class="p-button-sm p-button-success"
                (click)="addAccountField()">
        </button>
      </div>

      <!-- Lista de cuentas COP -->
      <ng-container *ngFor="let acc of accounts; let i = index">
        <div class="p-field p-col-12 p-md-5">
          <label>Cuenta COP</label>
          <p-dropdown 
            [options]="accountCops" 
            [(ngModel)]="accounts[i].accountCop" 
            optionValue="id" 
            optionLabel="name"
            placeholder="Selecciona cuenta"
            (onChange)="onAccountAmountChange()">
          </p-dropdown>
        </div>
        
        <div class="p-field p-col-12 p-md-5">
          <label>Pesos recibidos</label>
          <p-inputNumber 
            [(ngModel)]="accounts[i].amount" 
            mode="currency" 
            currency="COP" 
            [min]="0"
            class="w-full"
            (onInput)="onAccountAmountChange()">
          </p-inputNumber>
        </div>
        
        <div class="p-field p-col-12 p-md-2 p-d-flex p-ai-center">
          <button pButton icon="pi pi-trash" 
                  class="p-button-danger p-button-text"
                  (click)="removeAccountField(i)">
          </button>
        </div>
      </ng-container>

      <!-- Resumen calculado -->
      <div class="p-col-12 p-mt-3">
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 1px solid #dee2e6;">
          <div class="p-grid">
            <div class="p-col-12 p-md-6">
              <label style="font-weight: bold; display: block; margin-bottom: 0.5rem;">Total pesos:</label>
              <p style="font-size: 1.2rem; color: #28a745; margin: 0;">
                {{ totalPesosSolana | currency:'COP':'symbol':'1.0-0' }}
              </p>
            </div>
            <div class="p-col-12 p-md-6">
              <label style="font-weight: bold; display: block; margin-bottom: 0.5rem;">Tasa calculada:</label>
              <p style="font-size: 1.2rem; color: #007bff; margin: 0;">
                {{ calcularTasaSolana() | number:'1.2-2' }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- ============================================ -->
    <!-- FORMULARIO NORMAL (SIN CAMBIOS) -->
    <!-- ============================================ -->
    <ng-container *ngIf="!isSolanaSale">
      <!-- Pregunta si es cliente especial -->
      <div class="flexcontainer">
        <label>¿Es un cliente especial?</label>
        <div class="p-formgroup-inline">
          <p-radioButton name="tipo" value="false" [(ngModel)]="isSpecialClient" label="No"></p-radioButton>
          <p-radioButton name="tipo" value="true" [(ngModel)]="isSpecialClient" label="Sí"></p-radioButton>
        </div>
      </div>
      <br>

      <!-- Cuenta y Monto -->
      <div class="p-field p-col-12 p-md-6">
        <label>Cuenta</label>
        <input pInputText [value]="selected.nameAccount" readonly class="w-full" />
      </div>
      <br>
      <div class="p-field p-col-12 p-md-6">
        <label>Monto (USDT)</label>
        <input pInputText [value]="selected.dollars | number:'1.0-2'" readonly class="w-full" />
      </div>
      <br>

      <!-- Si es cliente especial -->
      <ng-container *ngIf="isSpecialClient">
        <div class="p-field p-col-12">
          <label>Selecciona Cliente</label>
          <p-dropdown [options]="clientes" [(ngModel)]="selectedClientId" optionValue="id" optionLabel="nombre"
            placeholder="Selecciona cliente"></p-dropdown>
        </div>
        <div class="p-field p-col-12 p-md-6">
          <label>Tasa</label>
          <input type="number" pInputText [(ngModel)]="saleRate" inputmode="numeric" />
        </div>
        <div class="p-field p-col-12 p-md-6">
          <label>Total en pesos</label>
          <input pInputText [value]="totalPesos | currency:'COP'" readonly class="w-full" />
        </div>
      </ng-container>
      <br>

      <!-- Si NO es cliente especial -->
      <ng-container *ngIf="!isSpecialClient">
        <div class="p-field p-col-12 p-md-6">
          <label>Proveedor</label>
          <p-dropdown [options]="suppliers" [(ngModel)]="selectedSupplierId" optionValue="id" optionLabel="name"
            placeholder="Selecciona proveedor"></p-dropdown>
        </div>
        <br>
        <div class="p-field p-col-12 p-md-6">
          <label>Tasa</label>
          <input type="number" pInputText [(ngModel)]="saleRate" inputmode="numeric" />
        </div>
        <br>
        <div class="p-field p-col-12 p-md-6">
          <label>Total en pesos</label>
          <input pInputText [value]="totalPesos | currency:'COP'" readonly class="w-full" />
        </div>
        <br>
        <div class="p-col-12 p-mt-3">
          <h3>Cuentas COP</h3>
          <button pButton icon="pi pi-plus" label="Agregar cuenta" class="p-button-sm"
            (click)="addAccountField()"></button>
        </div>
        <br>
        <ng-container *ngFor="let acc of accounts; let i = index">
          <div class="p-field p-col-12 p-md-5">
            <p-dropdown [options]="accountCops" [(ngModel)]="accounts[i].accountCop" optionValue="id" optionLabel="name"
              placeholder="Cuenta COP"></p-dropdown>
          </div>
          <div class="p-field p-col-12 p-md-5">
            <p-inputNumber [(ngModel)]="accounts[i].amount" mode="currency" currency="COP" [min]="0"
              class="w-full"></p-inputNumber>
          </div>
          <div class="p-field p-col-12 p-md-2 p-d-flex p-ai-center">
            <button pButton icon="pi pi-trash" class="p-button-danger p-button-text"
              (click)="removeAccountField(i)"></button>
          </div>
        </ng-container>

        <div class="p-field p-col-12 p-md-6 p-mt-3">
          <label>Monto a proveedor</label>
          <input pInputText [value]="montoProveedor | currency:'COP'" readonly class="w-full" />
        </div>
      </ng-container>
    </ng-container>

  </div>

  <!-- Footer con botones condicionales -->
  <ng-template pTemplate="footer">
    <button pButton label="Cancelar" icon="pi pi-times" 
            class="p-button-danger" 
            (click)="closeModal()">
    </button>
    
    <!-- Botón para ventas Solana -->
    <button *ngIf="isSolanaSale" 
            pButton label="Asignar" icon="pi pi-check" 
            class="p-button-success" 
            (click)="saveSaleSolana()"
            [disabled]="accounts.length === 0 || totalPesosSolana === 0">
    </button>
    
    <!-- Botón para ventas normales -->
    <button *ngIf="!isSolanaSale" 
            pButton label="Guardar" icon="pi pi-check" 
            class="p-button-success" 
            (click)="saveSale()"
            [disabled]="!saleRate || (isSpecialClient && !selectedClientId) || (!isSpecialClient && !selectedSupplierId)">
    </button>
  </ng-template>
</p-dialog>