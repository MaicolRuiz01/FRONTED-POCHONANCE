<div class="contenedor-clientes">
  <div class="header">
    <h2>Clientes Especiales</h2>
    <button pButton label="Nuevo Cliente" icon="pi pi-plus" class="p-button-success" (click)="abrirModal()"></button>
  </div>

  <div class="botones-acciones">
    <button pButton label="Pagar a Cliente" icon="pi pi-credit-card" class="p-button-danger" (click)="abrirModalPago()">
    </button>

    <button pButton label="Transferir a Proveedor" icon="pi pi-exchange" class="p-button-info"
      (click)="abrirModalTransferencia()">
    </button>
  </div>

  <!-- Modal para Transferencia Cliente → Proveedor -->
  <p-dialog header="Transferencia Cliente a Proveedor" [(visible)]="displayTransferModal" [modal]="true"
    [style]="{ width: '400px' }">
    <form class="p-fluid">
      <!-- Cliente Origen -->
      <div class="p-field">
        <label>Cliente Origen</label>
        <p-dropdown [options]="clientes" [(ngModel)]="transferencia.clientId" name="clientId" optionLabel="nombre"
          optionValue="id" placeholder="Seleccione cliente origen">
        </p-dropdown>
      </div>

      <!-- Proveedor Destino -->
      <div class="p-field">
        <label>Proveedor Destino</label>
        <p-dropdown [options]="proveedores" [(ngModel)]="transferencia.supplierId" name="supplierId" optionLabel="name"
          optionValue="id" placeholder="Seleccione proveedor destino">
        </p-dropdown>
      </div>

      <!-- Monto -->
      <div class="p-field">
        <label>Monto a Transferir</label>
        <p-inputNumber [(ngModel)]="transferencia.amount" name="amount" mode="currency" currency="COP" [min]="0">
        </p-inputNumber>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="displayTransferModal = false">
      </button>
      <button pButton label="Confirmar Transferencia" icon="pi pi-check" class="p-button-success"
        (click)="confirmarTransferencia()"
        [disabled]="!transferencia.clientId || !transferencia.supplierId || !transferencia.amount">
      </button>
    </ng-template>
  </p-dialog>


  <br>

  <div class="total-container">
    <p-card styleClass="total-card">
      <ng-template pTemplate="content">
        <div class="total-content">
          <i class="pi pi-calculator" style="margin-right: 6px;"></i>
          <strong>Total de Clientes:</strong> {{ totalClientes | currency:'COP' }}
        </div>
      </ng-template>
    </p-card>
  </div>
  <br>
  <br>
  <!-- Grid de clientes -->
  <div class="grid-clientes">
  <div class="card" *ngFor="let cliente of clientes"
       (click)="onSelectCliente(cliente)">

    <h3>{{ cliente.nombre }}</h3>
    <p><strong>Usuario:</strong> {{ cliente.nameUser }}</p>
    <p><strong>Correo:</strong> {{ cliente.correo }}</p>
    <p>
      <strong>{{ cliente.saldo >= 0 ? 'Debemos:' : 'Debe:' }}</strong>
      {{ Math.abs(cliente.saldo) | currency:'COP' }}
    </p>
    <p><strong>Wallet:</strong> {{ cliente.wallet }}</p>

    <div class="acciones-card">
      <button pButton label="Editar" icon="pi pi-pencil" class="p-button-text p-button-sm"
              (click)="$event.stopPropagation(); abrirModalEditar(cliente)"></button>
    </div>
  </div>
</div>


  <!-- Modal de Movimientos del Cliente -->
  <p-dialog header="Movimientos del Cliente: {{ selectedCliente?.nombre }}"
          [(visible)]="showMovimientosDialog"
          [modal]="true"
          [style]="{width: '80vw'}"
          [closable]="true"
          (onHide)="showMovimientosDialog = false">

  <p-table 
    [value]="clienteMovimientos" 
    scrollable="true" 
    scrollHeight="400px"
    [responsive]="true">

    <ng-template pTemplate="header">
      <tr>
        <th>Fecha</th>
        <th>Tipo</th>
        <th>Monto (COP)</th>
        <th>Cuenta Origen</th>
        <th>Cuenta Destino</th>
        <th>Caja</th>
        <th>Cliente</th>
        <th>Proveedor</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-mov>
      <tr>
        <td>{{ mov.fecha | date:'short' }}</td>
        <td>{{ mov.tipo }}</td>
        <td>{{ mov.monto | currency:'COP':'symbol':'1.0-0' }}</td>
        <td>{{ mov.cuentaOrigen || '-' }}</td>
        <td>{{ mov.cuentaDestino || '-' }}</td>
        <td>{{ mov.caja || '-' }}</td>
        <td>{{ mov.pagoCliente || '-' }}</td>
        <td>{{ mov.pagoProveedor || '-' }}</td>
      </tr>
    </ng-template>
  </p-table>
</p-dialog>



  <!-- Modal crear cliente -->
  <p-dialog header="Crear Nuevo Cliente" [(visible)]="displayModal" [modal]="true" [style]="{ width: '400px' }">
    <form class="p-fluid">
      <div class="p-field">
        <label>Nombre</label>
        <input pInputText [(ngModel)]="nuevoCliente.nombre" name="nombre" />
      </div>
      <div class="p-field">
        <label>Usuario</label>
        <input pInputText [(ngModel)]="nuevoCliente.nameUser" name="nameUser" />
      </div>
      <div class="p-field">
        <label>Correo</label>
        <input pInputText [(ngModel)]="nuevoCliente.correo" name="correo" />
      </div>
      <div class="p-field">
        <label>Saldo Inicial</label>
        <p-inputNumber [(ngModel)]="nuevoCliente.saldo" name="saldo" mode="currency" currency="COP"></p-inputNumber>
      </div>
      <div class="p-field">
        <label>Wallet</label>
        <input pInputText [(ngModel)]="nuevoCliente.wallet" name="wallet" />
      </div>
    </form>




    <ng-template pTemplate="footer">
      <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="displayModal = false"></button>
      <button pButton label="Guardar" icon="pi pi-check" class="p-button-success" (click)="guardarCliente()"></button>
    </ng-template>
  </p-dialog>

  <!-- Modal de Pago entre Clientes -->
  <p-dialog header="Pago entre Clientes" [(visible)]="displayPagoModal" [modal]="true" [style]="{ width: '400px' }">
    <form class="p-fluid">
      <!-- Cliente Origen -->
      <div class="p-field">
        <label>Cliente Origen</label>
        <p-dropdown [options]="clientes" [(ngModel)]="pago.origenId" name="origen" optionLabel="nombre" optionValue="id"
          placeholder="Seleccione cliente origen">
        </p-dropdown>
        <br>
        <label>Tasa de Cliente Origen</label>
        <p-inputNumber [(ngModel)]="tasaOrigen" name="tasaOrigen" mode="currency" currency="COP"></p-inputNumber>
      </div>
      <br>

      <!-- Monto a pagar cliente origen-->
      <div class="p-field">
        <label>Monto a Pagar de cliente Origen</label>
        <p-inputNumber [(ngModel)]="pago.monto" name="monto" mode="currency" currency="COP" [min]="0">
        </p-inputNumber>
      </div>
      <br>
      <!-- Cliente Destino -->
      <div class="p-field">
        <label>Cliente Destino</label>
        <p-dropdown [options]="clientes" [(ngModel)]="pago.destinoId" name="destino" optionLabel="nombre"
          optionValue="id" placeholder="Seleccione cliente destino">
        </p-dropdown>
        <br>
        <label>Tasa de Cliente Destino</label>
        <p-inputNumber [(ngModel)]="tasaDestino" name="tasaDestino" mode="currency" currency="COP"></p-inputNumber>
        <br>
      </div>
      <br>
      <!-- Nota -->
      <div class="p-field">
        <label>Nota (opcional)</label>
        <input pInputText [(ngModel)]="pago.nota" name="nota" />
      </div>
    </form>

    <ng-template pTemplate="footer">
      <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="displayPagoModal = false">
      </button>
      <button pButton label="Confirmar Pago" icon="pi pi-check" class="p-button-success" (click)="confirmarPago()"
        [disabled]="!pago.origenId || !pago.destinoId || !pago.monto">
      </button>
    </ng-template>
  </p-dialog>

</div>

<p-dialog header="Editar Cliente"
          [(visible)]="displayEditModal"
          [modal]="true"
          [style]="{ width: '420px' }"
          (onHide)="cancelarEdicion()">

  <form class="p-fluid" *ngIf="editCliente">
    <div class="p-field">
      <label>Nombre</label>
      <input pInputText [(ngModel)]="editCliente.nombre" name="edit_nombre" />
    </div>

    <div class="p-field">
      <label>Usuario</label>
      <input pInputText [(ngModel)]="editCliente.nameUser" name="edit_nameUser" />
    </div>

    <div class="p-field">
      <label>Correo</label>
      <input pInputText [(ngModel)]="editCliente.correo" name="edit_correo" />
    </div>

    <div class="p-field">
      <label>Wallet</label>
      <input pInputText [(ngModel)]="editCliente.wallet" name="edit_wallet" />
    </div>

    <!-- Si quieres permitir tocar el saldo manualmente, deja este bloque.
         Si NO, quítalo para que el saldo solo cambie por procesos. -->
    <div class="p-field">
      <label>Saldo</label>
      <p-inputNumber [(ngModel)]="editCliente.saldo" name="edit_saldo"
                     mode="currency" currency="COP"></p-inputNumber>
    </div>

    <!-- Si manejas binanceId/accountId -->
    <!--
    <div class="p-field">
      <label>Binance ID</label>
      <input pInputText [(ngModel)]="editCliente.binanceId" name="edit_binanceId" />
    </div>
    -->
  </form>

  <ng-template pTemplate="footer">
    <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text"
            (click)="cancelarEdicion()"></button>
    <button pButton label="Guardar" icon="pi pi-check" class="p-button-success"
            (click)="guardarEdicion()" [disabled]="!editCliente?.nombre || !editCliente?.correo"></button>
  </ng-template>
</p-dialog>
