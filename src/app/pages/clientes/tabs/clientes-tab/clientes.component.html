<div class="contenedor-clientes">
  <div class="header">
    <h2>Clientes Especiales</h2>
    <button pButton label="Nuevo Cliente" icon="pi pi-plus" class="p-button-success" (click)="abrirModal()"></button>
  </div>

  <div class="botones-acciones">
    <button pButton label="Pagar a Cliente" icon="pi pi-credit-card" class="p-button-danger" (click)="abrirModalPago()">
    </button>

    <button pButton label="Transferir a Proveedor" icon="pi pi-exchange" class="p-button-info"
      (click)="abrirModalTransferencia()" disabled>
    </button>

    <button pButton label="Pagar a Proveedor (USDT)" icon="pi pi-send"
          class="p-button-success" (click)="abrirModalPagoClienteProveedor()"></button>
  </div>

  <!-- Modal para Transferencia Cliente → Proveedor -->
  <p-dialog header="Transferencia Cliente a Proveedor" [(visible)]="displayTransferModal" [modal]="true"
    [style]="{ width: '400px' }">
    <form class="p-fluid">
      <!-- Cliente Origen -->
      <div class="p-field">
        <label>Cliente Origen</label>
        <p-dropdown [options]="clientes" [(ngModel)]="transferencia.clientId" name="clientId" optionLabel="nombre"
          optionValue="id" placeholder="Seleccione cliente origen">
        </p-dropdown>
      </div>

      <!-- Proveedor Destino -->
      <div class="p-field">
        <label>Proveedor Destino</label>
        <p-dropdown [options]="proveedores" [(ngModel)]="transferencia.supplierId" name="supplierId" optionLabel="name"
          optionValue="id" placeholder="Seleccione proveedor destino">
        </p-dropdown>
      </div>

      <!-- Monto -->
      <div class="p-field">
        <label>Monto a Transferir</label>
        <p-inputNumber [(ngModel)]="transferencia.amount" name="amount" mode="currency" currency="COP" [min]="0">
        </p-inputNumber>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="displayTransferModal = false">
      </button>
      <button pButton label="Confirmar Transferencia" icon="pi pi-check" class="p-button-success"
        (click)="confirmarTransferencia()"
        [disabled]="!transferencia.clientId || !transferencia.supplierId || !transferencia.amount">
      </button>
    </ng-template>
  </p-dialog>


  <br>

  <div class="total-container">
    <p-card styleClass="total-card">
      <ng-template pTemplate="content">
        <div class="total-content">
          <i class="pi pi-calculator" style="margin-right: 6px;"></i>
          <strong>Total de Clientes:</strong> {{ totalClientes | currency:'COP' }}
        </div>
      </ng-template>
    </p-card>
  </div>
  <br>
  <br>
  <!-- Grid de clientes -->
  <div class="grid-clientes">
  <div class="card" *ngFor="let cliente of clientes"
       (click)="onSelectCliente(cliente)">

    <h3>{{ cliente.nombre }}</h3>
    <p><strong>Usuario:</strong> {{ cliente.nameUser }}</p>
    <p><strong>Correo:</strong> {{ cliente.correo }}</p>
    <p>
      <strong>{{ cliente.saldo >= 0 ? 'Debemos:' : 'Debe:' }}</strong>
      {{ Math.abs(cliente.saldo) | currency:'COP' }}
    </p>
    <!-- <p><strong>Wallet:</strong> {{ cliente.wallet }}</p> -->

    <div class="acciones-card">
      <button pButton label="Editar" icon="pi pi-pencil" class="p-button-text p-button-sm"
              (click)="$event.stopPropagation(); abrirModalEditar(cliente)"></button>
    </div>
  </div>
</div>


  <!-- Modal Movimientos/Compras -->
<p-dialog
  header="Cliente: {{ selectedCliente?.nombre }}"
  [(visible)]="showMovimientosDialog"
  [modal]="true"
  [style]="{ width: '85vw' }"
  [closable]="true"
  (onHide)="showMovimientosDialog = false">

  <p-tabView>

    <!-- TAB 1: Movimientos -->
    <p-tabPanel header="Movimientos">
      <p-table
        [value]="clienteMovimientos"
        scrollable="true"
        scrollHeight="400px"
        [responsive]="true">
        <ng-template pTemplate="header">
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Monto (COP)</th>
            <th>Cuenta Origen</th>
            <th>Cuenta Destino</th>
            <th>Caja</th>
            <th>Cliente</th>
            <th>Proveedor</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-mov>
          <tr>
            <td>{{ mov.fecha | date:'short' }}</td>
            <td>{{ mov.tipo }}</td>
            <td>{{ mov.monto | currency:'COP':'symbol':'1.0-0' }}</td>
            <td>{{ mov.cuentaOrigen || '-' }}</td>
            <td>{{ mov.cuentaDestino || '-' }}</td>
            <td>{{ mov.caja || '-' }}</td>
            <td>{{ mov.pagoCliente || '-' }}</td>
            <td>{{ mov.pagoProveedor || '-' }}</td>
          </tr>
        </ng-template>
      </p-table>
    </p-tabPanel>

    <!-- TAB 2: Compras -->
    <p-tabPanel header="Compras">
      <p-table
        [value]="comprasCliente"
        scrollable="true"
        scrollHeight="400px"
        [responsive]="true">
        <ng-template pTemplate="header">
          <tr>
            <th>Fecha</th>
            <th>Monto (Crypto)</th>
            <th>Símbolo</th>
            <th>Tasa</th>
            <th>PESOS (COP)</th>
            <th>Cuenta</th>
            <th>Id Depósito</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let(c) let-compra="rowData">
          <tr>
            <td>{{ compra.date | date:'short' }}</td>
            <td>{{ compra.amount }}</td>
            <td>{{ compra.cryptoSymbol || '-' }}</td>
            <td>{{ compra.tasa | number:'1.2-2' }}</td>
            <td>{{ compra.pesos | currency:'COP':'symbol':'1.0-0' }}</td>
            <td>{{ compra.nameAccount || '-' }}</td>
            <td>{{ compra.idDeposit || '-' }}</td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="p-text-center">Sin compras asignadas a este cliente.</td>
          </tr>
        </ng-template>
      </p-table>
    </p-tabPanel>

  </p-tabView>
</p-dialog>




  <!-- Modal crear cliente -->
  <p-dialog header="Crear Nuevo Cliente" [(visible)]="displayModal" [modal]="true" [style]="{ width: '400px' }">
    <form class="p-fluid">
      <div class="p-field">
        <label>Nombre</label>
        <input pInputText [(ngModel)]="nuevoCliente.nombre" name="nombre" />
      </div>
      <div class="p-field">
        <label>Usuario</label>
        <input pInputText [(ngModel)]="nuevoCliente.nameUser" name="nameUser" />
      </div>
      <div class="p-field">
        <label>Correo</label>
        <input pInputText [(ngModel)]="nuevoCliente.correo" name="correo" />
      </div>
      <div class="p-field">
        <label>Saldo Inicial</label>
        <p-inputNumber [(ngModel)]="nuevoCliente.saldo" name="saldo" mode="currency" currency="COP"></p-inputNumber>
      </div>
      <div class="p-field">
        <label>Wallet</label>
        <input pInputText [(ngModel)]="nuevoCliente.wallet" name="wallet" />
      </div>
    </form>




    <ng-template pTemplate="footer">
      <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="displayModal = false"></button>
      <button pButton label="Guardar" icon="pi pi-check" class="p-button-success" (click)="guardarCliente()"></button>
    </ng-template>
  </p-dialog>

  <!-- Modal de Pago entre Clientes -->
  <p-dialog header="Pago entre Clientes" [(visible)]="displayPagoModal" [modal]="true" [style]="{ width: '420px' }">
  <form class="p-fluid">
    <!-- Origen -->
    <div class="p-field">
      <label>Cliente Origen</label>
      <p-dropdown [options]="clientes" [(ngModel)]="pago.origenId" name="origen" optionLabel="nombre" optionValue="id"
                  placeholder="Seleccione cliente origen"></p-dropdown>
    </div>

    <!-- Monto en USDT -->
    <div class="p-field">
      <label>Monto (USDT)</label>
      <p-inputNumber [(ngModel)]="pagoUsdt" name="pagoUsdt" mode="decimal" [min]="0" [showButtons]="true" [locale]="'es-CO'"></p-inputNumber>
    </div>

    <!-- Tasa Origen (COP/USDT) y COP calculado -->
    <div class="p-field">
      <label>Tasa Cliente Origen (COP/USDT)</label>
      <p-inputNumber [(ngModel)]="tasaOrigen" name="tasaOrigen" mode="currency" currency="COP"></p-inputNumber>
    </div>
    <div class="p-field">
      <label>COP que paga Origen</label>
      <input pInputText [value]="pesosOrigen | currency:'COP'" readonly />
    </div>

    <!-- Destino -->
    <div class="p-field">
      <label>Cliente Destino</label>
      <p-dropdown [options]="clientes" [(ngModel)]="pago.destinoId" name="destino" optionLabel="nombre" optionValue="id"
                  placeholder="Seleccione cliente destino"></p-dropdown>
    </div>

    <!-- Tasa Destino (COP/USDT) y COP calculado -->
    <div class="p-field">
      <label>Tasa Cliente Destino (COP/USDT)</label>
      <p-inputNumber [(ngModel)]="tasaDestino" name="tasaDestino" mode="currency" currency="COP"></p-inputNumber>
    </div>
    <div class="p-field">
      <label>COP que recibe Destino</label>
      <input pInputText [value]="pesosDestino | currency:'COP'" readonly />
    </div>

    <!-- Nota -->
    <div class="p-field">
      <label>Nota (opcional)</label>
      <input pInputText [(ngModel)]="pago.nota" name="nota" />
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="displayPagoModal = false"></button>
    <button pButton label="Confirmar Pago" icon="pi pi-check" class="p-button-success"
            (click)="confirmarPago()"
            [disabled]="!pago.origenId || !pago.destinoId || !pagoUsdt || !tasaOrigen || !tasaDestino">
    </button>
  </ng-template>
</p-dialog>


</div>

<p-dialog header="Editar Cliente"
          [(visible)]="displayEditModal"
          [modal]="true"
          [style]="{ width: '420px' }"
          (onHide)="cancelarEdicion()">

  <form class="p-fluid" *ngIf="editCliente">
    <div class="p-field">
      <label>Nombre</label>
      <input pInputText [(ngModel)]="editCliente.nombre" name="edit_nombre" />
    </div>

    <div class="p-field">
      <label>Usuario</label>
      <input pInputText [(ngModel)]="editCliente.nameUser" name="edit_nameUser" />
    </div>

    <div class="p-field">
      <label>Correo</label>
      <input pInputText [(ngModel)]="editCliente.correo" name="edit_correo" />
    </div>

    <div class="p-field">
      <label>Wallet</label>
      <input pInputText [(ngModel)]="editCliente.wallet" name="edit_wallet" />
    </div>

    <!-- Si quieres permitir tocar el saldo manualmente, deja este bloque.
         Si NO, quítalo para que el saldo solo cambie por procesos. -->
    <div class="p-field">
      <label>Saldo</label>
      <p-inputNumber [(ngModel)]="editCliente.saldo" name="edit_saldo"
                     mode="currency" currency="COP"></p-inputNumber>
    </div>

    <!-- Si manejas binanceId/accountId -->
    <!--
    <div class="p-field">
      <label>Binance ID</label>
      <input pInputText [(ngModel)]="editCliente.binanceId" name="edit_binanceId" />
    </div>
    -->
  </form>

  <ng-template pTemplate="footer">
    <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text"
            (click)="cancelarEdicion()"></button>
    <!-- footer del modal de edición -->
<button pButton label="Guardar" icon="pi pi-check" class="p-button-success"
        (click)="guardarEdicion()"
        [disabled]="!editCliente?.nombre">
</button>

  </ng-template>
</p-dialog>
<p-dialog header="Pago en USDT: Cliente → Proveedor"
          [(visible)]="displayPagoCPModal" [modal]="true" [style]="{ width: '460px' }">

  <form class="p-fluid">
    <!-- Cliente Origen -->
    <div class="p-field">
      <label>Cliente Origen</label>
      <p-dropdown [options]="clientes"
                  [(ngModel)]="pagoCP.clienteId" name="cp_cliente"
                  optionLabel="nombre" optionValue="id"
                  placeholder="Seleccione cliente"></p-dropdown>
    </div>

    <!-- Proveedor Destino -->
    <div class="p-field">
      <label>Proveedor Destino</label>
      <p-dropdown [options]="proveedores"
                  [(ngModel)]="pagoCP.proveedorId" name="cp_proveedor"
                  optionLabel="name" optionValue="id"
                  placeholder="Seleccione proveedor"></p-dropdown>
    </div>

    <!-- Monto USDT -->
    <div class="p-field">
      <label>Monto (USDT)</label>
      <p-inputNumber [(ngModel)]="pagoCP.usdt" name="cp_usdt"
                     mode="decimal" [min]="0" [showButtons]="true"></p-inputNumber>
    </div>

    <!-- Tasa Cliente (COP/USDT) + COP -->
    <div class="p-field">
      <label>Tasa Cliente (COP/USDT)</label>
      <p-inputNumber [(ngModel)]="pagoCP.tasaCliente" name="cp_tasaCliente"
                     mode="currency" currency="COP"></p-inputNumber>
    </div>
    <div class="p-field">
      <label>COP (cliente)</label>
      <input pInputText [value]="pesosClienteCP | currency:'COP'" readonly />
    </div>

    <!-- Tasa Proveedor (COP/USDT) + COP -->
    <div class="p-field">
      <label>Tasa Proveedor (COP/USDT)</label>
      <p-inputNumber [(ngModel)]="pagoCP.tasaProveedor" name="cp_tasaProveedor"
                     mode="currency" currency="COP"></p-inputNumber>
    </div>
    <div class="p-field">
      <label>COP (proveedor)</label>
      <input pInputText [value]="pesosProveedorCP | currency:'COP'" readonly />
    </div>

    <!-- Nota -->
    <div class="p-field">
      <label>Nota (opcional)</label>
      <input pInputText [(ngModel)]="pagoCP.nota" name="cp_nota" />
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button pButton label="Cancelar" icon="pi pi-times"
            class="p-button-text"
            (click)="displayPagoCPModal = false"></button>

    <button pButton label="Confirmar Pago" icon="pi pi-check"
            class="p-button-success"
            (click)="confirmarPagoClienteProveedor()"
            [disabled]="!pagoCP.clienteId || !pagoCP.proveedorId || !pagoCP.usdt || !pagoCP.tasaCliente || !pagoCP.tasaProveedor">
    </button>
  </ng-template>
</p-dialog>
