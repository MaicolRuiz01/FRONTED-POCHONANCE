<div class="card">
<div class="p-grid p-dir-col p-align-center">
  <h2 class="section-title">Proveedores</h2>

  <!-- Bot√≥n para abrir el formulario de pago -->
  <div class="p-col-12 p-md-10" style="text-align: center; margin-top: 20px; display: flex; justify-content: start; gap: 10px;">
  <p-button label="Pago Proveedor" icon="pi pi-credit-card" (click)="togglePaymentForm()"
    styleClass="p-button-raised p-button-info"></p-button>

    <p-button label="Crear Proveedor" icon="pi pi-plus" (click)="showFormsupplier()"
      styleClass="p-button-raised p-button-info"></p-button>
  </div>
<br>

<div class="total-container">  
<p-card styleClass="total-card">
    <ng-template pTemplate="content">
      <div class="total-content">
        <i class="pi pi-calculator" style="margin-right: 6px;"></i>
        <strong>Total de proveedores:</strong> {{ totalProveedores | currency:'COP' }}
      </div>
    </ng-template>
</p-card>
</div>

  <!-- Contenedor de las tarjetas de proveedor -->
  <div class="p-grid p-justify-center p-card-container">
  <div *ngFor="let supplier of suppliers" class="card-wrapper">
    <p-card styleClass="account-card" (click)="onSelectSupplier(supplier)">
      <ng-template pTemplate="header">
        <div class="card-header">
          <i class="pi pi-user" style="margin-right: 8px;"></i> {{ supplier?.name }}
        </div>
      </ng-template>

      <ng-template pTemplate="content">
        <div class="account-details">
          <div class="card-row">
  <span class="label">
    {{ (supplier?.balance ?? 0) >= 0 ? 'Debemos:' : 'Debe:' }}
  </span>
  <span class="value">
    {{ Math.abs(supplier?.balance ?? 0) | currency:'COP' }}
  </span>
</div>

          <div class="card-row">
            <span class="label">√öltimo pago:</span>
            <span class="value">{{ supplier?.lastPaymentDate | date:'mediumDate' }}</span>
          </div>
        </div>
      </ng-template>
    </p-card>
  </div>
</div>

  <p-dialog
  header="Proveedor: {{ selectedSupplier?.name }}"
  [(visible)]="showPagosDialog"
  [modal]="true"
  [style]="{width: '80vw'}"
  [closable]="true"
  (onHide)="showPagosDialog = false">

  <p-tabView>

    <!-- TAB 1: Movimientos -->
    <p-tabPanel header="Movimientos">
      <ng-container *ngIf="!loadingMovs; else movsLoading">
        <app-lista-pagos [pagos]="movimientos"></app-lista-pagos>
      </ng-container>
      <ng-template #movsLoading>
        <div class="p-3">Cargando movimientos...</div>
      </ng-template>
    </p-tabPanel>

    <!-- TAB 2: Compras -->
    <p-tabPanel header="Compras">
      <ng-container *ngIf="!loadingCompras; else comprasLoading">
        <p-table
          [value]="comprasProveedor"
          scrollable="true"
          scrollHeight="400px"
          [responsive]="true">
          <ng-template pTemplate="header">
            <tr>
              <th>Fecha</th>
              <th>Monto (Crypto)</th>
              <th>S√≠mbolo</th>
              <th>Tasa</th>
              <th>PESOS (COP)</th>
              <th>Cuenta</th>
              <th>Id Dep√≥sito</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-row>
            <tr>
              <td>{{ row.date | date:'short' }}</td>
              <td>{{ row.amount }}</td>
              <td>{{ row.cryptoSymbol || '-' }}</td>
              <td>{{ row.tasa | number:'1.2-2' }}</td>
              <td>{{ row.pesos | currency:'COP':'symbol':'1.0-0' }}</td>
              <td>{{ row.nameAccount || '-' }}</td>
              <td>{{ row.idDeposit || '-' }}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="7" class="p-text-center">Sin compras asignadas a este proveedor.</td>
            </tr>
          </ng-template>
        </p-table>
      </ng-container>
      <ng-template #comprasLoading>
        <div class="p-3">Cargando compras...</div>
      </ng-template>
    </p-tabPanel>

  </p-tabView>
</p-dialog>



  <!-- Dialog de formulario de pago -->
  <p-dialog header="Formulario de Pago" [(visible)]="showPaymentForm" [modal]="true" [closable]="false"
  [style]="{width: '400px'}">
  <div class="p-fluid">
    <div class="p-grid">
      <div class="p-col-12 p-md-12">
        <label for="paymentMethod">Fuente de Pago:</label>
        <p-dropdown 
  [options]="paymentOptions"
  [(ngModel)]="paymentMethod"
  placeholder="Seleccione la fuente">
</p-dropdown>

      </div>

      <div class="p-col-12 p-md-6" *ngIf="paymentMethod === 'Cuenta Bancaria'">
        <label for="accountCop">Cuenta COP:</label>
        <p-dropdown [options]="accountCops" [(ngModel)]="selectedAccountCop" optionLabel="name"
          placeholder="Seleccione Cuenta COP"></p-dropdown>
      </div>

      <div class="p-col-12 p-md-6" *ngIf="paymentMethod === 'Caja'">
        <label for="caja">Caja:</label>
        <p-dropdown [options]="cajas" [(ngModel)]="selectedCaja" optionLabel="name" placeholder="Seleccione Caja">
        </p-dropdown>
      </div>

      <div class="p-col-12 p-md-6" *ngIf="paymentMethod === 'Cliente'">
  <label for="cliente">Cliente:</label>
  <p-dropdown 
    [options]="clientes" 
    [(ngModel)]="selectedCliente" 
    optionLabel="nombre" 
    placeholder="Seleccione Cliente">
  </p-dropdown>
</div>


      <!-- üîπ Selecci√≥n de proveedor origen (solo si el m√©todo es Proveedor) -->
<div class="p-col-12 p-md-6" *ngIf="paymentMethod === 'Proveedor'">
  <label for="proveedorOrigen">Proveedor Origen:</label>
  <p-dropdown 
    [options]="suppliers" 
    [(ngModel)]="selectedProveedorOrigen" 
    optionLabel="name" 
    placeholder="Seleccione Proveedor Origen">
  </p-dropdown>
</div>


      <div class="p-col-12 p-md-6">
        <label for="supplier">Proveedor:</label>
        <p-dropdown [options]="suppliers" [(ngModel)]="selectedSupplier" optionLabel="name"
          placeholder="Seleccione Proveedor"></p-dropdown>
      </div>

      <div class="p-col-12 p-md-6">
        <label for="amount">Monto:</label>
        <p-inputNumber id="amount" [(ngModel)]="amount" mode="decimal" currency="USD" [min]="0" [prefix]="'$'"
          [showButtons]="true" placeholder="Monto a pagar" inputMode="decimal"> </p-inputNumber>
      </div>

      <div class="p-col-12" style="text-align: right; margin-top: 20px;">
        <button pButton type="button" label="Realizar Pago" icon="pi pi-check" (click)="makePayment()"></button>
        <button pButton type="button" label="Cancelar" icon="pi pi-times" class="p-button-secondary"
          (click)="togglePaymentForm()"></button>
      </div>
    </div>
  </div>
</p-dialog>

  <!-- Dialog de formulario para crear proveedor -->
  <p-dialog header="Formulario de Proveedor" [(visible)]="showform" [modal]="true" [closable]="false"
    [style]="{width: '400px'}">
    <div class="p-fluid">
      <div class="p-grid">
        <br>
        <div class="p-col-12 p-md-6">
          <label for="name">Nombre :</label>
          <input id="nombre" [(ngModel)]="Supplier_name" placeholder="Ingrese el nombre">
        </div>

        <br>
        <div class="p-col-12 p-md-6">
          <label for="balance" class="p-d-block p-mb-2">Balance inicial</label>
          <p-inputNumber id="balance" [(ngModel)]="Supplier_balance" mode="decimal" currency="COP" [min]="0"
            [prefix]="'$'" [showButtons]="true" placeholder="Ej: 1000" class="decimal"></p-inputNumber>
        </div>

        <br>
        <div class="p-field p-col-12">
      <label for="lastPaymentDate" class="p-d-block p-mb-2">√öltima fecha de pago</label>
      <p-calendar 
        id="lastPaymentDate" 
        [(ngModel)]="SupplierlastPaymentDate" 
        dateFormat="yy-mm-dd" 
        showIcon="true"
        class="p-inputtext-sm"
        placeholder="Seleccione la fecha"
      ></p-calendar>
    </div>

        <br>
        <div class="p-col-12" style="text-align: right; margin-top: 20px;">
          <button pButton type="button" label="Crear Proveedor" icon="pi pi-check"
            (click)="createSupplier({ name: Supplier_name, balance: Supplier_balance, lastPaymentDate: SupplierlastPaymentDate })"></button>
          <button pButton type="button" label="Cancelar" icon="pi pi-times" class="p-button-secondary"
            (click)="showFormsupplier()"></button>
        </div>

      </div>
    </div>
  </p-dialog>

  <p *ngIf="suppliers.length === 0">No hay proveedores registrados.</p>
</div>
</div>