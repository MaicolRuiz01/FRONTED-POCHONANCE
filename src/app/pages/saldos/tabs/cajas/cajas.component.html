<div class="button-container">
  <button pButton title="Agregar Caja" icon="pi pi-plus"
          class="p-button-success p-button-sm p-button-rounded"
          (click)="displayCajaDialog = true"></button>
</div>
<br>

<div class="total-container">
  <p-card styleClass="total-card">
    <ng-template pTemplate="content">
      <div class="total-content">
        <i class="pi pi-calculator" style="margin-right: 6px;"></i>
        <strong>Total Cajas:</strong> {{ totalCajas | currency:'COP' }}
      </div>
    </ng-template>
  </p-card>
</div>
<br><br>

<!-- Cartas de cajas -->
<div class="p-grid p-justify-center p-card-container">
  <div *ngFor="let caja of cajas" class="card-wrapper">
    <p-card styleClass="account-card" (click)="verMovimientos(caja)">
      <ng-template pTemplate="header">
        <div class="card-header">
          <i class="pi pi-briefcase" style="margin-right: 8px;"></i> {{ caja?.name }}
        </div>
      </ng-template>

      <ng-template pTemplate="content">
  <div class="account-details">
    <p>Saldo inicial del dia: {{caja.saldoInicialDelDia | number:'1.2-2'}}</p>
    <div class="card-row">
      <span class="label">Saldo:</span>
      <span class="value">{{ caja?.saldo | currency:'COP' }}</span>
    </div>

    <button
      pButton
      label="Ajustar saldo"
      icon="pi pi-refresh"
      class="p-button-warning p-button-text p-button-sm"
      (click)="abrirAjusteCaja(caja); $event.stopPropagation()">
    </button>
  </div>
</ng-template>

    </p-card>
  </div>
</div>

<!-- Dialog: crear caja -->
<p-dialog header="Crear Nueva Caja" [(visible)]="displayCajaDialog" [modal]="true">
  <div class="p-fluid">
    <label>Nombre de Caja</label>
    <input type="text" pInputText [(ngModel)]="nuevaCaja.name" />

    <label>Saldo Inicial</label>
    <p-inputNumber [(ngModel)]="nuevaCaja.saldo" name="saldoInicial"
                   mode="currency" currency="COP" [min]="0"></p-inputNumber>
  </div>

  <p-footer>
    <button pButton label="Cancelar" (click)="displayCajaDialog = false" class="p-button-text"></button>
    <button pButton label="Guardar" class="p-button-success" (click)="guardarCaja()"></button>
  </p-footer>
</p-dialog>

<!-- Dialog: movimientos por caja -->
<p-dialog header="Movimientos de Caja: {{ cajaSeleccionada?.name }}"
          [(visible)]="showMovsDialog"
          [modal]="true"
          [style]="{ width: '80vw' }"
          [closable]="true">

  <p-tabView>
    <!-- TAB 1: Movimientos -->
    <p-tabPanel header="Movimientos">
      <ng-container *ngIf="!loadingMovs; else loadingMovsTpl">
        <p-table [value]="movimientosCaja" scrollable="true" scrollHeight="420px" [responsive]="true">
          <ng-template pTemplate="header">
            <tr>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Monto (COP)</th>
              <th>Cuenta Origen</th>
              <th>Cuenta Destino</th>
              <th>Caja</th>
              <th>Cliente</th>
              <th>Proveedor</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-mov>
            <tr>
              <td>{{ mov.fecha | date:'short' }}</td>
              <td>{{ mov.tipo }}</td>
              <td>{{ mov.monto | currency:'COP':'symbol':'1.0-0' }}</td>
              <td>{{ mov.cuentaOrigen || '-' }}</td>
              <td>{{ mov.cuentaDestino || '-' }}</td>
              <td>{{ mov.caja || '-' }}</td>
              <td>{{ mov.pagoCliente || '-' }}</td>
              <td>{{ mov.pagoProveedor || '-' }}</td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="8" class="p-text-center">Sin movimientos para esta caja.</td>
            </tr>
          </ng-template>
        </p-table>
      </ng-container>

      <ng-template #loadingMovsTpl>
        <div class="p-3">Cargando movimientos...</div>
      </ng-template>
    </p-tabPanel>

    <!-- TAB 2: Ajustes de saldo -->
    <p-tabPanel header="Ajustes de saldo">
      <ng-container *ngIf="!loadingAjustesCaja; else loadingAjustesTpl">
        <p-table
          [value]="ajustesCaja"
          scrollable="true"
          scrollHeight="420px"
          [responsive]="true">

          <ng-template pTemplate="header">
            <tr>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Monto</th>
              <th>Motivo</th>
              <th>Actor</th>
              <th>Saldo anterior</th>
              <th>Saldo nuevo</th>
              <th>Diferencia</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-aj>
            <tr>
              <td>{{ aj.fecha | date:'short' }}</td>
              <td>{{ aj.tipo }}</td>
              <td>{{ aj.monto | currency:'COP':'symbol':'1.0-0' }}</td>
              <td>{{ aj.motivo || '-' }}</td>
              <td>{{ aj.actor || '-' }}</td>
              <td>{{ aj.saldoAnterior | currency:'COP':'symbol':'1.0-0' }}</td>
              <td>{{ aj.saldoNuevo | currency:'COP':'symbol':'1.0-0' }}</td>
              <td [ngClass]="{ 'text-green': aj.diferencia > 0, 'text-red': aj.diferencia < 0 }">
                {{ aj.diferencia | currency:'COP':'symbol':'1.0-0' }}
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="8" class="p-text-center">Sin ajustes de saldo para esta caja.</td>
            </tr>
          </ng-template>
        </p-table>
      </ng-container>

      <ng-template #loadingAjustesTpl>
        <div class="p-3">Cargando ajustes de saldo...</div>
      </ng-template>
    </p-tabPanel>
  </p-tabView>
</p-dialog>


<app-ajuste-saldo-dialog
  *ngIf="cajaAjuste"
  [visible]="showAjusteCaja"
  (visibleChange)="showAjusteCaja = $event"
  [entidad]="'CAJA'"
  [entidadId]="cajaAjuste.id"
  [nombreEntidad]="cajaAjuste.name"
  [saldoActual]="cajaAjuste.saldo || 0"
  (ajusteRealizado)="onAjusteCajaRealizado()">
</app-ajuste-saldo-dialog>

