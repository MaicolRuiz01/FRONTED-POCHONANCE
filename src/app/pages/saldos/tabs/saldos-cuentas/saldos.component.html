<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<p-toolbar styleClass="mb-4">
  <!-- Card SALDO TOTAL -->
  <div class="saldo-card saldo-card-main p-3 border rounded">
    <h4>Saldo total</h4>

    <p>${{ balanceTotalExterno | number:'1.0-2' }} USDT</p>
    <p><strong>Tasa Promedio:</strong> {{ latestRate | number:'1.2-2' }}</p>

    <p *ngIf="latestRate > 0">
      ≈ {{ balanceTotalExternoCop | number:'1.0-0' }} COP
    </p>

    <p *ngIf="latestRate === 0" style="color:#c0392b; font-weight:600;">
      Sin tasa promedio disponible
    </p>
  </div>


  <!-- Card CRIPTOS HOY -->
<div class="saldo-card saldo-card-crypto p-3 border rounded">
  <h4>Criptos (hoy)</h4>

  <!-- total en USDT (y COP) arriba -->
  <div class="crypto-total" *ngIf="tasasCriptoHoy.length > 0">
    Total ≈ 
    <strong>{{ totalCriptosUsdt | number:'1.2-2' }} USDT</strong>
    <span *ngIf="latestRate > 0">
      · ≈ {{ (totalCriptosUsdt * latestRate) | number:'1.0-0' }} COP
    </span>
  </div>

  <ng-container *ngIf="tasasCriptoHoy.length > 0; else noCriptoData">
    <div class="crypto-list">
      <div class="crypto-flip-row" *ngFor="let t of tasasCriptoHoy">
        <div class="crypto-flip-inner">
          <!-- Frente: nombre + saldo en cripto -->
          <div class="crypto-face front">
            <span class="crypto-symbol">
              {{ t.cripto }}
            </span>
            <span class="crypto-amount">
              {{ t.saldoFinalCripto | number:'1.4-8' }} {{ t.cripto }}
            </span>
          </div>

          <!-- Reverso: tasa USDT + total USDT + COP -->
          <div class="crypto-face back">
            <span class="crypto-symbol">
              {{ t.cripto }}
            </span>
            <span class="crypto-extra">
              {{ t.tasaPromedioDia | number:'1.4-8' }} USDT ·
              {{ (t.saldoFinalCripto * t.tasaPromedioDia) | number:'1.2-2' }} USDT
              <span *ngIf="latestRate > 0">
                · {{ (t.saldoFinalCripto * t.tasaPromedioDia * latestRate) | number:'1.0-0' }} COP
              </span>
            </span>
          </div>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-template #noCriptoData>
    <p style="margin:0;font-size:0.85rem;">
      Sin datos de tasas cripto hoy.
    </p>
  </ng-template>
</div>


  <!-- resto del toolbar igual -->
  <ng-template pTemplate="left">
    <button pButton title="Nueva Cuenta" icon="pi pi-plus" class="p-button-success" (click)="openNew()"></button>
  </ng-template>
  <ng-template pTemplate="right">
    <button
      pButton
      label="Sincronizar saldos"
      icon="pi pi-sync"
      class="p-button-info"
      [loading]="syncingAll"
      (click)="syncAllBalances()">
    </button>
  </ng-template>
</p-toolbar>


<br><br>
<div *ngIf="loading" class="spinner-container">
<p-progressSpinner></p-progressSpinner>
</div>
<p *ngIf="loading">Cargando cuentas...</p>
<div class="grid" *ngIf="accounts.length > 0">
  <div *ngFor="let account of accounts" 
       class="custom-card" 
       style="--grad:#4cafef,#2196f3; --background:#fff; --text:#444;">
    
    <!-- Botones flotantes -->
    <div class="multi-button">
      <button class="fas fa-pen" title="Editar" (click)="editarCuenta(account)"></button>
      <button class="fas fa-trash" title="Eliminar" (click)="confirmDelete(account)"></button>
    </div>

    <div class="card-header">
      {{ account.accountType }}
    </div>

    <div class="icon">
      <i class="fa-thin fa-wallet"></i>
    </div>

    <!-- Contenido clickable -->
<div class="card-body" (click)="toggleText(account)">
  <div class="button-container">
    <!-- Solo dejamos el botón de sincronizar interno -->
    <button pButton
          icon="pi pi-refresh"
          severity="warning"
          variant="outlined"
          [raised]="true"
          size="small"
          [loading]="account.syncing"
          title="Sincronizar saldos internos"
          (click)="syncInternalAccount(account, $event)">
    </button>
  </div>

  <ng-container *ngIf="!account.isFlipped; else detalles"> 
    <!-- AHORA: saldo externo es lo principal -->
    <p><strong>Saldo Externo (USDT)</strong>: {{ account.saldoExterno | number:'1.2-2' }}</p>

        <div class="crypto-detail">
      <!-- loading local por card -->
      <p *ngIf="account.loadingBalances">
        <i class="pi pi-spin pi-spinner"></i> Cargando criptos...
      </p>

      <ng-container *ngIf="!account.loadingBalances">
        <table *ngIf="account.balances && account.balances.length > 0; else sinCriptos">
          <thead>
            <tr>
              <th>Cripto</th>
              <th>Cantidad</th>
              <th>≈ USDT</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let b of account.balances">
              <td>{{ b.symbol }}</td>
              <td>{{ b.quantity | number:'1.4-8' }}</td>
              <td>{{ b.usdtValue | number:'1.2-2' }} USDT</td>
            </tr>
          </tbody>
        </table>

        <ng-template #sinCriptos>
          <p class="muted">Sin criptos registradas.</p>
        </ng-template>
      </ng-container>
    </div>

  </ng-container>



  <ng-template #detalles>
    <p><strong>Correo:</strong> {{ account.correo }}</p>
    <p><strong>Wallet:</strong> {{ account.address }}</p>
  </ng-template>
</div>



  </div>
</div>

<p-dialog 
 [header]="'Seleccionar Tipo de Cuenta'"
 [(visible)]="selectAccountTypeDialog"
 [modal]="true"
 [style]="{ width: '400px' }"
 [baseZIndex]="1100"
 [closable]="false"
 [draggable]="false"
 [resizable]="false">

 <div class="p-fluid p-text-center">
<p>¿Qué tipo de cuenta Binance deseas crear?</p>
<p-dropdown 
[options]="tiposCuenta"
[(ngModel)]="selectedAccountType"
placeholder="Seleccione tipo"
[showClear]="true"
[appendTo]="'body'">
</p-dropdown>
</div>

<ng-template pTemplate="footer">
<button pButton 
              label="Continuar" 
              icon="pi pi-angle-right" 
              class="p-button-success"
              (click)="openCreateAccountDialog()"
              [disabled]="!selectedAccountType"></button>
  </ng-template>
</p-dialog>

<p-dialog 
  [header]="editMode ? 'Editar cuenta Binance' : 'Crear nueva cuenta Binance'"
  [(visible)]="createAccountDialog"
  [modal]="false"
  [style]="{ width: '500px' }"
  [baseZIndex]="1100">

  <div class="p-fluid">
      <div class="p-field">
          <label for="name">Nombre* :</label>
          <br>
          <input id="name" type="text" pInputText [(ngModel)]="newAccount.name" />
      </div>
<br>
      <div class="p-field">
          <label for="reference">Id de cuenta Binance* :</label>
          <input id="reference" type="text" pInputText [(ngModel)]="newAccount.referenceAccount" />
      </div>
<br>
      <div class="p-field">
          <label for="correo">Correo electrónico* :</label>
          <input id="correo" type="email" pInputText [(ngModel)]="newAccount.correo" />
      </div>
<br>
      <div class="p-field">
          <label for="user">Usuario Binance :</label>
          <input id="user" type="text" pInputText [(ngModel)]="newAccount.userBinance" />
      </div>
<br>
      <div class="p-field">
          <label for="balance">Saldo inicial en USDT* :</label>
          <input id="balance" type="number" pInputText [(ngModel)]="newAccount.balance" />
      </div>
<br>
      <div class="p-field">
          <label for="wallet">Wallet (dirección USDT)* :</label>
          <input id="wallet" type="text" pInputText [(ngModel)]="newAccount.address" />
      </div>
<br>
      <div class="p-field">
          <label>Tipo de cuenta* :</label>
          <p-dropdown [options]="tiposCuenta"
                      [(ngModel)]="newAccount.tipo"
                      placeholder="Seleccione tipo"
                      [showClear]="true"
                      [appendTo]="'body'">
          </p-dropdown>
      </div>
<br>
      <div *ngIf="newAccount.tipo === 'BINANCE'" class="p-field">
          <label>API Key*</label>
          <input type="text" pInputText [(ngModel)]="newAccount.apiKey" />
      </div>
<br>
      <div *ngIf="newAccount.tipo === 'BINANCE'" class="p-field">
          <label>API Secret*</label>
          <input type="text" pInputText [(ngModel)]="newAccount.apiSecret" />
      </div>
  </div>

  <ng-template pTemplate="footer">
      <button pButton 
              label="Cancelar" 
              icon="pi pi-times" 
              class="p-button-danger"
              (click)="cancelarNuevaCuenta()"></button>

      <!-- Aquí cambiamos dinámicamente -->
      <button pButton 
              [label]="editMode ? 'Actualizar' : 'Crear'" 
              icon="pi pi-check" 
              class="p-button-success"
              (click)="guardarCuenta()"></button>
  </ng-template>
</p-dialog>
